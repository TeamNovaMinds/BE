name: Deploy to EC2

on:
  push:
    branches:
      - release

jobs:
  JustFridgeDeploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: .env íŒŒì¼ ìƒì„±
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•˜ê¸°
        run: ./gradlew clean build

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECRì— ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ìƒì„±
        run: docker build -t just-fridge-server .

      - name: Docker ì´ë¯¸ì§€ì— Tag ë¶™ì´ê¸°
        run: docker tag just-fridge-server ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: ECRì— Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: EC2 ë°°í¬ ë””ë ‰í† ë¦¬ ì •ë¦¬ ë° ê¶Œí•œ ì„¤ì •
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            echo "ğŸ§¹ ë°°í¬ ë””ë ‰í† ë¦¬ ì „ì²´ë¥¼ ì •ë¦¬í•˜ê³  ê¶Œí•œì„ ì„¤ì •í•©ë‹ˆë‹¤..."
            # 1. sudoë¥¼ ì‚¬ìš©í•´ ì´ì „ í´ë”ë¥¼ í™•ì‹¤íˆ ì‚­ì œí•©ë‹ˆë‹¤.
            sudo rm -rf ~/deployment
            # 2. ë°°í¬ í´ë”ë¥¼ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
            mkdir -p ~/deployment
            # 3. ìƒˆë¡œ ë§Œë“  í´ë”ì˜ ì†Œìœ ìë¥¼ ubuntu ìœ ì €ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
            sudo chown -R ${{ secrets.EC2_USERNAME }}:${{ secrets.EC2_USERNAME }} ~/deployment
            echo "âœ… ì •ë¦¬ ë° ê¶Œí•œ ì„¤ì • ì™„ë£Œ!"

      - name: EC2ì— ë°°í¬ íŒŒì¼ë“¤ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "compose.yml,nginx/,scripts/,.env"
          target: "~/deployment/"
          strip_components: 0

      - name: EC2ì—ì„œ Docker Composeë¡œ ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            cd ~/deployment

            echo "ğŸš€ Just Fridge ë°°í¬ ì‹œì‘..."

            # âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "ğŸ“¦ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker compose down || true
            docker system prune -f || true

            # âœ… ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ”„ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker compose pull app || {
              echo "âŒ ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ECR ë¡œê·¸ì¸ ì¬ì‹œë„..."
              aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 600627338836.dkr.ecr.ap-northeast-2.amazonaws.com
              docker compose pull app
            }

            # âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘
            echo "ğŸ—ï¸ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
            docker compose up -d

            # âœ… ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
            echo "â³ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° (30ì´ˆ)..."
            sleep 30

            # âœ… ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
            docker compose ps

            # âœ… nginx ë¡œê·¸ í™•ì¸ (ë¬¸ì œ ì§„ë‹¨ìš©) - ì¶”ê°€!
            echo "ğŸ” nginx ë¡œê·¸ í™•ì¸..."
            docker compose logs nginx

            # âœ… nginx ì„¤ì • íŒŒì¼ ê²€ì¦ (ë¬¸ì œ ì§„ë‹¨ìš©) - ì¶”ê°€!
            echo "ğŸ§ª nginx ì„¤ì • íŒŒì¼ ê²€ì¦..."
            docker compose exec nginx nginx -t || {
              echo "âŒ nginx ì„¤ì • íŒŒì¼ ì˜¤ë¥˜ ë°œê²¬!"
              echo "ğŸ“‹ nginx ì˜¤ë¥˜ ë¡œê·¸:"
              docker compose logs nginx
              exit 1
            }

            # âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬..."
            for i in {1..10}; do
              if curl -f http://localhost/; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë™ì‘ í™•ì¸!"
                break
              else
                echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/10)"
                sleep 10
              fi
            done

            echo "âœ… ë°°í¬ ì™„ë£Œ!"

      - name: SSL ì¸ì¦ì„œ ì´ˆê¸° ì„¤ì •
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: false
          script: |
            cd ~/deployment
            
            chmod +x scripts/init-ssl.sh
            
            ./scripts/init-ssl.sh || echo "âš ï¸ SSL ì„¤ì • ì‹¤íŒ¨ (ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰ í•„ìš”)"
            
            echo ""
            echo "ğŸ¯ ë°°í¬ ì™„ë£Œ! ì„œë¹„ìŠ¤ URL:"
            echo "  - HTTP: http://justfridge.p-e.kr"
            echo "  - HTTPS: https://justfridge.p-e.kr (SSL ì„¤ì • í›„)"