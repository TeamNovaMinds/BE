name: Deploy to EC2

on:
  push:
    branches:
      - release

jobs:
  JustFridgeDeploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: .env íŒŒì¼ ìƒì„±
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•˜ê¸°
        run: ./gradlew clean build

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECRì— ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ìƒì„±
        run: docker build -t just-fridge-server .

      - name: Docker ì´ë¯¸ì§€ì— Tag ë¶™ì´ê¸°
        run: docker tag just-fridge-server ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: ECRì— Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: EC2ì— ë°°í¬ íŒŒì¼ë“¤ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "compose.yml,nginx/,scripts/,.env"
          target: "~/deployment/"
          strip_components: 0

      - name: EC2ì—ì„œ Docker Composeë¡œ ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            cd ~/deployment
            
            echo "ğŸš€ Just Fridge ë°°í¬ ì‹œì‘..."
            
            # âœ… ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            echo "ğŸ“¦ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘..."
            docker-compose down || true
            docker system prune -f || true
            
            # âœ… ìµœì‹  ì´ë¯¸ì§€ Pull (ECR Credential Helperê°€ ìë™ìœ¼ë¡œ ì¸ì¦ ì²˜ë¦¬)
            echo "ğŸ”„ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker-compose pull app || {
              echo "âŒ ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ECR ë¡œê·¸ì¸ ì¬ì‹œë„..."
              aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 600627338836.dkr.ecr.ap-northeast-2.amazonaws.com
              docker-compose pull app
            }
            
            # âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
            echo "ğŸ—ï¸ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
            docker-compose up -d
            
            # âœ… ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
            echo "â³ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° (30ì´ˆ)..."
            sleep 30
            
            # âœ… ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
            echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸..."
            docker-compose ps
            
            # âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬
            echo "ğŸ¥ ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ ì²´í¬..."
            for i in {1..10}; do
              if curl -f http://localhost/; then
                echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì •ìƒ ë™ì‘ í™•ì¸!"
                break
              else
                echo "â³ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° ì¤‘... ($i/10)"
                sleep 10
              fi
            done
            
            # âœ… nginx ì„¤ì • ê²€ì¦
            echo "ğŸ§ª Nginx ì„¤ì • ê²€ì¦..."
            docker-compose exec nginx nginx -t
            
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo ""
            echo "ğŸ“‹ ì„œë¹„ìŠ¤ ì •ë³´:"
            echo "  - HTTP: http://justfridge.p-e.kr"
            echo "  - ë¡œê·¸ í™•ì¸: docker-compose logs -f"
            echo "  - ìƒíƒœ í™•ì¸: docker-compose ps"

      - name: SSL ì¸ì¦ì„œ ì´ˆê¸° ì„¤ì •  # âœ… ì²« ë°°í¬ ì‹œì—ë§Œ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: false  # âœ… SSL ì‹¤íŒ¨í•´ë„ ë°°í¬ëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
          script: |
            cd ~/deployment
            
            # âœ… SSL ì¸ì¦ì„œê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            if docker-compose exec -T nginx test -f /etc/letsencrypt/live/justfridge.p-e.kr/fullchain.pem; then
              echo "ğŸ” SSL ì¸ì¦ì„œê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤. ê°±ì‹  ì²´í¬ë§Œ ìˆ˜í–‰..."
              docker-compose exec -T certbot certbot renew --dry-run || echo "âš ï¸ SSL ê°±ì‹  ì²´í¬ ì‹¤íŒ¨ (ì •ìƒì ì¼ ìˆ˜ ìˆìŒ)"
            else
              echo "ğŸ” SSL ì¸ì¦ì„œ ì´ˆê¸° ë°œê¸‰ ì‹œì‘..."
            
              # âœ… ì¸ì¦ì„œ ë°œê¸‰ (ì‹¤ì œ ì´ë©”ì¼ ì£¼ì†Œë¡œ ë³€ê²½ í•„ìš”)
              docker-compose exec -T certbot certbot certonly \
                --webroot \
                --webroot-path=/var/www/certbot \
                --email kiroro0814@naver.com \
                --agree-tos \
                --no-eff-email \
                --non-interactive \
                -d justfridge.p-e.kr || {
                echo "âŒ SSL ì¸ì¦ì„œ ë°œê¸‰ ì‹¤íŒ¨"
                echo "ğŸ” certbot ë¡œê·¸ í™•ì¸:"
                docker-compose logs certbot
                exit 0  # âœ… SSL ì‹¤íŒ¨í•´ë„ ë°°í¬ëŠ” ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬
              }
            
              if [ $? -eq 0 ]; then
                echo "âœ… SSL ì¸ì¦ì„œ ë°œê¸‰ ì„±ê³µ!"
            
                # âœ… nginx ì¬ì‹œì‘ (HTTPS í™œì„±í™”)
                docker-compose restart nginx
            
                # âœ… HTTPS í…ŒìŠ¤íŠ¸
                sleep 10
                if curl -f https://justfridge.p-e.kr/; then
                  echo "ğŸ‰ HTTPS ì„¤ì • ì™„ë£Œ ë° ì •ìƒ ë™ì‘ í™•ì¸!"
                else
                  echo "âš ï¸ HTTPS ì„¤ì • ì™„ë£Œí–ˆì§€ë§Œ ì‘ë‹µ í™•ì¸ ì‹¤íŒ¨ (DNS ì „íŒŒ ëŒ€ê¸° ì¤‘ì¼ ìˆ˜ ìˆìŒ)"
                fi
              fi
            fi
            
            echo ""
            echo "ğŸ¯ ë°°í¬ ì™„ë£Œ! ì„œë¹„ìŠ¤ URL:"
            echo "  - HTTP: http://justfridge.p-e.kr"
            echo "  - HTTPS: https://justfridge.p-e.kr (SSL ì„¤ì • í›„)"