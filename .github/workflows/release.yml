name: Deploy to EC2

on:
  push:
    branches:
      - release

jobs:
  JustFridgeDeploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì¹˜
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: temurin

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      - name: .env íŒŒì¼ ìƒì„±
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: í…ŒìŠ¤íŠ¸ ë° ë¹Œë“œí•˜ê¸°
        run: ./gradlew clean build

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECRì— ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ìƒì„±
        run: docker build -t just-fridge-server .

      - name: Docker ì´ë¯¸ì§€ì— Tag ë¶™ì´ê¸°
        run: docker tag just-fridge-server ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: ECRì— Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: EC2ì— ë°°í¬ ë° SSL ì„¤ì •
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            # 0. ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ì„ ê²½ìš°)
            mkdir -p ~/deployment
            cd ~/deployment
            
            # 1. GitHub Actionsì—ì„œ ì „ì†¡ëœ íŒŒì¼ë“¤ì„ EC2 ì„œë²„ì˜ ì„ì‹œ ìœ„ì¹˜ë¡œ ì˜®ê¸°ê¸°
            # 'scp-action' ëŒ€ì‹ , sshë¥¼ í†µí•´ ì§ì ‘ íŒŒì¼ì„ ë°›ì•„ ì••ì¶•ì„ í•´ì œí•©ë‹ˆë‹¤.
            echo "ğŸšš GitHubì—ì„œ EC2ë¡œ ë°°í¬ íŒŒì¼ë“¤ì„ ì•ˆì „í•˜ê²Œ ì „ì†¡í•©ë‹ˆë‹¤..."
            cat <<'EOF' > docker-compose.yml
            ${{ env.COMPOSE_FILE }}
            EOF
            
            cat <<'EOF' > .env
            ${{ secrets.ENV_FILE }}
            EOF

            mkdir -p nginx/conf.d/websites nginx/conf.d/websites-init
            
            cat <<'EOF' > nginx/nginx.conf
            ${{ env.NGINX_CONF }}
            EOF

            cat <<'EOF' > nginx/conf.d/default.conf
            ${{ env.NGINX_DEFAULT_CONF }}
            EOF

            cat <<'EOF' > nginx/conf.d/upstream.conf
            ${{ env.NGINX_UPSTREAM_CONF }}
            EOF
            
            cat <<'EOF' > nginx/conf.d/websites/justfridge.p-e.kr.conf
            ${{ env.NGINX_SITE_CONF }}
            EOF
            
            cat <<'EOF' > nginx/conf.d/websites-init/justfridge.p-e.kr-initial.conf
            ${{ env.NGINX_SITE_INIT_CONF }}
            EOF
            
            mkdir -p scripts
            cat <<'EOF' > scripts/init-ssl.sh
            ${{ env.SSL_SCRIPT }}
            EOF
            chmod +x scripts/init-ssl.sh

            echo "âœ… íŒŒì¼ ì „ì†¡ ì™„ë£Œ."

            # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ“¦ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë° ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker compose down --remove-orphans || true
            docker image prune -f || true

            # 3. ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ”„ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker compose pull app || {
              echo "âŒ ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ECR ë¡œê·¸ì¸ ì¬ì‹œë„..."
              aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 600627338836.dkr.ecr.ap-northeast-2.amazonaws.com
              docker compose pull app
            }
            
            # 4. SSL ì¸ì¦ì„œ ë°œê¸‰/ê°±ì‹  (ê°€ì¥ ë¨¼ì € ì‹¤í–‰!)
            echo "ğŸ” SSL ì¸ì¦ì„œ í™•ì¸ ë° ë°œê¸‰/ê°±ì‹ ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
            ./scripts/init-ssl.sh

            # 5. ëª¨ë“  ì„œë¹„ìŠ¤ ìµœì¢… ì‹œì‘
            echo "ğŸ—ï¸ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ìµœì¢…ì ìœ¼ë¡œ ì‹œì‘/ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
            docker compose up -d --remove-orphans

            # 6. ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° ë° ìƒíƒœ í™•ì¸
            echo "â³ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° (20ì´ˆ)..."
            sleep 20
            echo "ğŸ” ìµœì¢… ì„œë¹„ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤..."
            docker compose ps
            
            echo "âœ… ë°°í¬ ë° SSL ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        env:
          COMPOSE_FILE: ${{ toJSON(file('compose.yml')) }}
          ENV_FILE: ${{ secrets.ENV_FILE }}
          NGINX_CONF: ${{ toJSON(file('nginx/nginx.conf')) }}
          NGINX_DEFAULT_CONF: ${{ toJSON(file('nginx/conf.d/default.conf')) }}
          NGINX_UPSTREAM_CONF: ${{ toJSON(file('nginx/conf.d/upstream.conf')) }}
          NGINX_SITE_CONF: ${{ toJSON(file('nginx/conf.d/websites/justfridge.p-e.kr.conf')) }}
          NGINX_SITE_INIT_CONF: ${{ toJSON(file('nginx/conf.d/websites-init/justfridge.p-e.kr-initial.conf')) }}
          SSL_SCRIPT: ${{ toJSON(file('scripts/init-ssl.sh')) }}