name: Deploy to EC2

on:
  push:
    branches:
      - release

jobs:
  JustFridgeDeploy:
    runs-on: ubuntu-latest
    steps:
      - name: Github Repository íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
        uses: actions/checkout@v4

      - name: .env íŒŒì¼ ìƒì„±
        run: echo "${{ secrets.ENV_FILE }}" > .env

      - name: AWS Resourceì— ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ AWS credentials ì„¤ì •
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: ECRì— ë¡œê·¸ì¸
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker ì´ë¯¸ì§€ ìƒì„±
        run: docker build -t just-fridge-server .

      - name: Docker ì´ë¯¸ì§€ì— Tag ë¶™ì´ê¸°
        run: docker tag just-fridge-server ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: ECRì— Docker ì´ë¯¸ì§€ í‘¸ì‹œ
        run: docker push ${{ steps.login-ecr.outputs.registry }}/just-fridge-server:latest

      - name: EC2 ë°°í¬ ë””ë ‰í† ë¦¬ ì •ë¦¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            echo "ğŸ§¹ ì´ì „ ë°°í¬ ë””ë ‰í† ë¦¬ë¥¼ sudoë¥¼ ì‚¬ìš©í•˜ì—¬ ê°•ì œë¡œ ì‚­ì œí•©ë‹ˆë‹¤..."
            sudo rm -rf ~/deployment
            echo "âœ… ì´ì „ ë””ë ‰í† ë¦¬ ì •ë¦¬ ì™„ë£Œ. ìƒˆ ë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            mkdir ~/deployment

      - name: EC2ì— ë°°í¬ íŒŒì¼ë“¤ ì „ì†¡
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "compose.yml,nginx/,scripts/,.env"
          target: "~/deployment/"
          strip_components: 0

      - name: EC2ì— ë°°í¬ ë° SSL ì„¤ì •
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            cd ~/deployment

            echo "ğŸš€ Just Fridge ë°°í¬ ë° SSL ì„¤ì • ì‹œì‘..."

            # 1. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° ì´ë¯¸ì§€ ì •ë¦¬
            echo "ğŸ“¦ ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ë° ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker compose down --remove-orphans || true
            docker image prune -f || true

            # 2. ìµœì‹  ì´ë¯¸ì§€ Pull
            echo "ğŸ”„ ìµœì‹  ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
            docker compose pull app || {
              echo "âŒ ì´ë¯¸ì§€ pull ì‹¤íŒ¨, ECR ë¡œê·¸ì¸ ì¬ì‹œë„..."
              aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 600627338836.dkr.ecr.ap-northeast-2.amazonaws.com
              docker compose pull app
            }
            
            # 3. SSL ì¸ì¦ì„œ ë°œê¸‰/ê°±ì‹  (ê°€ì¥ ë¨¼ì € ì‹¤í–‰!)
            # ì´ ìŠ¤í¬ë¦½íŠ¸ê°€ ë‚´ë¶€ì ìœ¼ë¡œ Nginxë¥¼ ì„ì‹œ HTTP ëª¨ë“œë¡œ ì‹¤í–‰í•˜ê³  ì¸ì¦ì„œë¥¼ ë°›ì•„ì˜µë‹ˆë‹¤.
            echo "ğŸ” SSL ì¸ì¦ì„œ í™•ì¸ ë° ë°œê¸‰/ê°±ì‹ ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
            chmod +x scripts/init-ssl.sh
            ./scripts/init-ssl.sh

            # 4. ëª¨ë“  ì„œë¹„ìŠ¤ ìµœì¢… ì‹œì‘
            # init-ssl.shê°€ Nginxë¥¼ ìµœì¢… HTTPS ì„¤ì •ìœ¼ë¡œ ì¬ì‹œì‘í–ˆìœ¼ë¯€ë¡œ,
            # ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ìµœì‹  ìƒíƒœë¡œ ë‹¤ì‹œ í•œë²ˆ ì˜¬ë¦½ë‹ˆë‹¤.
            echo "ğŸ—ï¸ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ìµœì¢…ì ìœ¼ë¡œ ì‹œì‘/ì¬ì‹œì‘í•©ë‹ˆë‹¤..."
            docker compose up -d --remove-orphans

            # 5. ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸°
            echo "â³ ì„œë¹„ìŠ¤ ì•ˆì •í™” ëŒ€ê¸° (20ì´ˆ)..."
            sleep 20

            echo "âœ… ë°°í¬ ë° SSL ì„¤ì •ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"